<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<title>
		Hurricane Harvey Aug 2017
	</title>
	<!-- highcharts -->
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<!-- arcgis api -->
	<link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />
	<script src="https://js.arcgis.com/4.24/"></script>
	<style>
		html,
		body {
			padding: 0;
			margin: 0;
			height: 100%;
			width: 100%;
		}

		#container_plots {
			position: absolute;
			right: 0;
			height: 100%;
			width: 0%;
			overflow: scroll;
		}

		#container_PatientsCount_zipcode,
		#container_PatientsCount_ip,
		#container_PatientsCount_op,
		#container_PatientsCount_all {
			float: left;
			height: 300px;
			width: 100%;
			overflow: scroll;
		}

		#viewDiv {
			padding: 0;
			margin: 0;
			height: 100%;
			width: 100%;
			float: left;
		}

		#infoDiv {
			padding: 8px;
			font-family: Avenir Next W00;
			font-size: 1em;
		}

		#titleDiv {
			padding: 10px;
			width: 320px;
		}

		#titleText {
			font-size: 15pt;
			font-family: 'Times New Roman', Times, serif;
			padding-bottom: 2px;
		}
	</style>
</head>

<body>
	<!-- Map -->
	<div id="titleDiv" class="esri-widget">
		<div id="titleText"><b>The Impact of Hurricane Harvey</b></div>
		<div>Hope you can learn something from the terrible hurricane.</div>
	</div>
	<div id="viewDiv"></div>

	<!-- Patients Count Comparison Plots-->
	<div id="container_plots">
		<div id="container_PatientsCount_zipcode"></div>
		<div id="container_PatientsCount_op"></div>
		<div id="container_PatientsCount_ip"></div>
		<div id="container_PatientsCount_all"></div>
	</div>

	<!-- filter -->
	<div id="infoDiv" class="esri-widget" style="display: none">
		Select Time:
		<select id="time-select" class="esri-widget ">
			<option value="view_patientscount1q2016" selected>1Q2016</option>
			<option value="view_patientscount2q2016">2Q2016</option>
			<option value="view_patientscount3q2016">3Q2016</option>
			<option value="view_patientscount4q2016">4Q2016</option>
			<option value="view_patientscount1q2017">1Q2017</option>
			<option value="view_patientscount2q2017">2Q2017</option>
			<option value="view_patientscount3q2017">3Q2017</option>
			<option value="view_patientscount4q2017">4Q2017</option>
			<option value="view_patientscount1q2018">1Q2018</option>
			<option value="view_patientscount2q2018">2Q2018</option>
			<option value="view_patientscount3q2018">3Q2018</option>
			<option value="view_patientscount4q2018">4Q2018</option>
			<option value="view_patientscount1q2019">1Q2019</option>
			<option value="view_patientscount2q2019">2Q2019</option>
		</select>
		Classification:
		<select id="class-select" class="esri-widget ">
			<option value="equal-interval" selected>Equal interval</option>
			<option value="quantile">Quantile</option>
			<option value="natural-breaks">Natual Breaks</option>
			<option value="manual">Manual</option>
		</select>
		Breaks:
		<input type="number" id="num-classes" class="esri-widget " value="5" min="2" max="10" />
	</div>

	<script>
		var chart = Highcharts.chart('container_PatientsCount_ip', {
			chart: {
				type: 'line',
				// height: 300,
				// width: 300
			},
			title: {
				text: 'Patients Count <br/> (Inpatients)',
				style: {
					fontSize: 10
				}
			},
			// subtitle: {
			// 	text: "Around hospitals"
			// },
			xAxis: {
				categories: ['3Q2017', '4Q2017', '1Q2018', '2Q2018', '3Q2018']
			},
			yAxis: {
				title: {
					text: 'Patients Count',
					style: {
						fontSize: 10
					}
				},
				// tickPositions: [100000, 150000, 200000, 250000,
				// 	300000, 350000, 400000, 450000, 500000, 550000,
				// 	600000, 650000, 700000, 750000, 800000, 850000,
				// 	900000, 950000, 1000000, 1050000, 1100000, 1150000,
				// 	1200000, 1250000, 1300000, 1350000, 1400000, 1450000,
				// 	1500000, 1550000, 1600000, 1650000, 1700000, 1750000,
				// 	1800000, 1850000, 1900000, 1950000, 2000000, 2050000,
				// 	2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
				// 	2400000, 2450000, 2500000, 2550000, 2600000, 2650000,
				// 	2700000, 2750000, 2800000, 2850000, 2900000, 2950000,
				// ]

			},
			plotOptions: {
				line: {
					dataLabels: {
						enabled: true
					},
					enableMouseTracking: false
				}
			},
			series: [{
				name: 'Windswath1',
				data: [354012, 374808, 386973, 367046, 361596]
			}, {
				name: 'Windswath2',
				data: [212805, 211479, 221587, 183781, 205249]
			}, {
				name: 'Windswath3',
				data: [218253, 188535, 187849, 169994, 172894]
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 400
					},
					chartOptions: {
						chart: {
							height: "100%"
						}
					}
				}]
			}
		});
		var chart = Highcharts.chart('container_PatientsCount_op', {
			chart: {
				type: 'line',
				// height: 300,
				// width: 300
			},
			title: {
				text: 'Patients Count <br/> (Outpatients)',
				style: {
					fontSize: 10
				}
			},
			// subtitle: {
			// 	text: "title"
			// },
			xAxis: {
				categories: ["3Q2017", "4Q2017", "1Q2018", "2Q2018", "3Q2018"]
			},
			yAxis: {
				title: {
					text: 'Patients Count',
					style: {
						fontSize: 10
					}
				},
				// tickPositions: [100000, 150000, 200000, 250000,
				// 	300000, 350000, 400000, 450000, 500000, 550000,
				// 	600000, 650000, 700000, 750000, 800000, 850000,
				// 	900000, 950000, 1000000, 1050000, 1100000, 1150000,
				// 	1200000, 1250000, 1300000, 1350000, 1400000, 1450000,
				// 	1500000, 1550000, 1600000, 1650000, 1700000, 1750000,
				// 	1800000, 1850000, 1900000, 1950000, 2000000, 2050000,
				// 	2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
				// 	2400000, 2450000, 2500000, 2550000, 2600000, 2650000,
				// 	2700000, 2750000, 2800000, 2850000, 2900000, 2950000,
				// ]

			},
			plotOptions: {
				line: {
					dataLabels: {
						enabled: true
					},
					enableMouseTracking: false
				}
			},
			series: [{
				name: 'Windswath1',
				data: [2227450, 2468898, 2482563, 2349343, 2312185]
			}, {
				name: 'Windswath2',
				data: [1875672, 2066829, 1938637, 1933519, 1804269]
			}, {
				name: 'Windswath3',
				data: [1929642, 1994104, 1904134, 1675079, 1648692]
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 400
					},
					chartOptions: {
						chart: {
							height: "100%"
						}
					}
				}]
			}
		});
		var chart = Highcharts.chart('container_PatientsCount_all', {
			chart: {
				type: 'line',
				// height: 300,
				// width: 600
				// height: 400,
				// width: 200
			},
			title: {
				text: 'Patients Count <br/> (Inpatients + Outpatients)',
				style: {
					fontSize: 10
				}
			},
			// subtitle: {
			// 	text: "Around hospitals"
			// },
			xAxis: {
				categories: ["3Q2017", "4Q2017", "1Q2018", "2Q2018", "3Q2018"]
			},
			yAxis: {
				title: {
					text: 'Patients Count',
					style: {
						fontSize: 10
					}
				},
				// tickPositions: [100000, 150000, 200000, 250000,
				// 	300000, 350000, 400000, 450000, 500000, 550000,
				// 	600000, 650000, 700000, 750000, 800000, 850000,
				// 	900000, 950000, 1000000, 1050000, 1100000, 1150000,
				// 	1200000, 1250000, 1300000, 1350000, 1400000, 1450000,
				// 	1500000, 1550000, 1600000, 1650000, 1700000, 1750000,
				// 	1800000, 1850000, 1900000, 1950000, 2000000, 2050000,
				// 	2100000, 2150000, 2200000, 2250000, 2300000, 2350000,
				// 	2400000, 2450000, 2500000, 2550000, 2600000, 2650000,
				// 	2700000, 2750000, 2800000, 2850000, 2900000, 2950000,
				// ]

			},
			plotOptions: {
				line: {
					dataLabels: {
						enabled: true
					},
					enableMouseTracking: false
				}
			},
			series: [{
				name: 'Windswath1',
				data: [2581462, 2843706, 2869536, 2716389, 2673781]
			}, {
				name: 'Windswath2',
				data: [2088477, 2278308, 2160224, 2117300, 2009518]
			}, {
				name: 'Windswath3',
				data: [2147895, 2182639, 2091983, 1845073, 1821586]
			}],
			responsive: {
				rules: [{
					condition: {
						maxWidth: 400
					},
					chartOptions: {
						chart: {
							height: "100%"
						}
					}
				}]
			}
		});

		require([
			"esri/Map",
			"esri/views/MapView",
			"esri/widgets/BasemapGallery",
			"esri/layers/FeatureLayer",
			"esri/layers/TileLayer",
			"esri/layers/WMTSLayer",
			"esri/layers/GroupLayer",
			"esri/widgets/LayerList",
			"esri/widgets/Legend",
			"esri/widgets/Expand",
			"esri/renderers/ClassBreaksRenderer",
			"esri/renderers/SimpleRenderer",
			"esri/widgets/Swipe",
			"esri/core/reactiveUtils",
			"esri/smartMapping/renderers/color",
			"esri/smartMapping/statistics/histogram",
			"esri/widgets/smartMapping/ClassedColorSlider",
			"esri/widgets/TimeSlider",
			"esri/widgets/Home"
		], function (
			Map,
			MapView,
			BasemapGallery,
			FeatureLayer,
			TileLayer,
			WMTSLayer,
			GroupLayer,
			LayerList,
			Legend,
			Expand,
			ClassBreaksRenderer,
			SimpleRenderer,
			Swipe,
			reactiveUtils,
			colorRendererCreator,
			histogram,
			ClassedColorSlider,
			TimeSlider,
			Home
		) {
			var infoDiv = document.getElementById("infoDiv")

			const map = new Map({
				basemap: "topo-vector"
			});

			const home_center = [-95.3, 29.8]
			const home_zoom = 7
			const view = new MapView({
				container: "viewDiv",
				map: map,
				center: home_center, // longitude, latitude
				zoom: home_zoom
			});

			view.ui.add("titleDiv", "top-right");

			// Add the home button to the top left corner of the view
			const homeBtn = new Home({
				view: view
			});
			view.ui.add(homeBtn, "top-left");

			function view_go_home() {
				view.goTo({
					center: home_center,
					zoom: home_zoom
				});
			}

			// Layers
			// ----------------------------------------- patients count -----------------------------------------
			const url_patientscount = "https://services2.arcgis.com/4aUxCaDLaSFPHO9o/arcgis/rest/services/view_patientscount/FeatureServer";
			var view_patientscount1q2016 = new FeatureLayer({
				id: "view_patientscount1q2016",
				title: "Patients Count: 1Q2016",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 0,
				listMode: "show",
				visible: false
			});
			var view_patientscount2q2016 = new FeatureLayer({
				id: "view_patientscount2q2016",
				title: "Patients Count: 2Q2016",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 1,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount3q2016 = new FeatureLayer({
				id: "view_patientscount3q2016",
				title: "Patients Count: 3Q2016",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 2,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount4q2016 = new FeatureLayer({
				id: "view_patientscount4q2016",
				title: "Patients Count: 4Q2016",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 3,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount1q2017 = new FeatureLayer({
				id: "view_patientscount1q2017",
				title: "Patients Count: 1Q2017",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 4,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount2q2017 = new FeatureLayer({
				id: "view_patientscount2q2017",
				title: "Patients Count: 2Q2017",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 5,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount3q2017 = new FeatureLayer({
				id: "view_patientscount3q2017",
				title: "Patients Count: 3Q2017",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 6,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount4q2017 = new FeatureLayer({
				id: "view_patientscount4q2017",
				title: "Patients Count: 4Q2017",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 7,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount1q2018 = new FeatureLayer({
				id: "view_patientscount1q2018",
				title: "Patients Count: 1Q2018",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 8,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount2q2018 = new FeatureLayer({
				id: "view_patientscount2q2018",
				title: "Patients Count: 2Q2018",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 9,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount3q2018 = new FeatureLayer({
				id: "view_patientscount3q2018",
				title: "Patients Count: 3Q2018",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 10,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount4q2018 = new FeatureLayer({
				id: "view_patientscount4q2018",
				title: "Patients Count: 4Q2018",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 11,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount1q2019 = new FeatureLayer({
				id: "view_patientscount1q2019",
				title: "Patients Count: 1Q2019",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 12,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});
			var view_patientscount2q2019 = new FeatureLayer({
				id: "view_patientscount2q2019",
				title: "Patients Count: 2Q2019",
				url: url_patientscount,
				outFields: ["*"],
				layerId: 13,
				opacity: 0,
				legendEnabled: false,
				listMode: "hide"
			});

			// ----------------------------------------- hospitals in texas -----------------------------------------
			var layer_hospital = new FeatureLayer({
				id: "hospital",
				title: "Texas Hospitals",
				url: "https://services2.arcgis.com/4aUxCaDLaSFPHO9o/arcgis/rest/services/TX_hospital/FeatureServer",
				outFields: ["THCIC_ID", "provider_n", "F1Q2016", "F2Q2016", "F3Q2016", "F4Q2016", "F1Q2017", "F2Q2017", "F3Q2017", "F4Q2017",
					"F1Q2018", "F2Q2018", "F3Q2018", "F4Q2018", "F1Q2019", "F2Q2019"],
				visible: false,
				// opacity: 0,
				legendEnabled: false,
				popupTemplate: {
					title: "Hospitals in Texas",
					content: [{
						type: "fields", // FieldsContentElement
						fieldInfos: [{
							fieldName: "THCIC_ID",
							label: "THCIC ID"
						},
						{
							fieldName: "provider_n",
							label: "Provider Name"
						}
						]
					},
					{
						type: "media",
						mediaInfos: [{
							title: "<b>Time series of Patients Counts</b>",
							type: "line-chart",
							caption: "Before and after Hurricane Harvey",
							value: {
								fields: ["F1Q2016", "F2Q2016", "F3Q2016", "F4Q2016", "F1Q2017", "F2Q2017", "F3Q2017", "F4Q2017",
									"F1Q2018", "F2Q2018", "F3Q2018", "F4Q2018", "F1Q2019", "F2Q2019"
								]
							}
						}]
					}
					]
				},
				// popupEnabled: false
			});

			reactiveUtils.watch(
				() => layer_hospital.visible,
				(visible) => {
					if (visible) {
						view.goTo({
							center: [-99, 31],
							zoom: home_zoom - 1
						});
					} else {
						view_go_home()
					}
				});
			// ----------------------------------------- Hurricane Harvey Trajectory -----------------------------------------
			const url_HurricaneHarvey = "https://services2.arcgis.com/4aUxCaDLaSFPHO9o/arcgis/rest/services/NHC_NOAA_Harvey_best_track/FeatureServer";
			var layer_HurricaneHarvey_floodmap = new TileLayer({
				id: "HurricaneHarvey_floodmap",
				url: "https://tiles.arcgis.com/tiles/4aUxCaDLaSFPHO9o/arcgis/rest/services/Harvey_FloodExtentsCombined_tif/MapServer",
				title: "Flood map",
				// opacity: 0,
				visible: false,
				// legendEnabled: false,
				listMode: "hide-children"
			});
			var layer_HurricaneHarvey_points = new FeatureLayer({
				id: "HurricaneHarvey_points",
				url: url_HurricaneHarvey,
				title: "Track points",
				outFields: ["*"],
				layerId: 0,
				// opacity: 0,
				// legendEnabled: false,
				popupTemplate: {
					// autocasts as new PopupTemplate()
					title: "{STORMNAME} Track Point",
					content: [{
						type: "fields", // FieldsContentElement
						fieldInfos: [{
							fieldName: "DTG", label: "Date (UTC)"
						},
						{
							fieldName: "STORMTYPE", label: "Storm type"
						},
						{
							fieldName: "INTENSITY", label: "Intensity (mph)"
						},
						{
							fieldName: "SS", label: "Severity index (0-4)"
						},
						{
							fieldName: "LAT", label: "Latitude"
						},
						{
							fieldName: "LON", label: "Longitude"
						}]
					}]
				},
				// popupEnabled: false
			});
			var layer_HurricaneHarvey_lines = new FeatureLayer({
				id: "HurricaneHarvey_lines",
				url: url_HurricaneHarvey,
				title: "Track lines",
				outFields: ["*"],
				layerId: 1,
				// opacity: 0,
				// legendEnabled: false,
				popupTemplate: {
					// autocasts as new PopupTemplate()
					title: "HARVEY Track line",
					content: [{
						type: "fields", // FieldsContentElement
						fieldInfos: [
							{
								fieldName: "STORMTYPE", label: "Storm type"
							},
							{
								fieldName: "SS", label: "Storm severity code"
							}
						]
					}]
				},
				// popupEnabled: false
			});
			var layer_HurricaneHarvey_windswath = new FeatureLayer({
				id: "HurricaneHarvey_windswath",
				url: url_HurricaneHarvey,
				title: "Track windswath",
				outFields: ["*"],
				layerId: 2,
				visible: true,
				// opacity: 0,
				// legendEnabled: false,
				popupTemplate: {
					title: "HARVEY Track windswath extent",
					content: [{
						type: "fields", // FieldsContentElement
						fieldInfos: [
							{
								fieldName: "RADII", label: "Radii"
							},
							{
								fieldName: "STARTDTG", label: "Start Date-Time (UTC)"
							},
							{
								fieldName: "ENDDTG", label: "End Date-Time (UTC)"
							}
						]
					}]
				},
				// popupEnabled: false
			});

			const hurricane_harvey_trajectory = new GroupLayer({
				title: "Harvey Trajectory",
				visible: true,
				layers: [layer_HurricaneHarvey_floodmap, layer_HurricaneHarvey_windswath, layer_HurricaneHarvey_lines, layer_HurricaneHarvey_points]
			})

			reactiveUtils.watch(
				() => hurricane_harvey_trajectory.visible,
				(visible) => {
					if (visible) {
						view_go_home()
					} else {
						view_go_home()
					}
				});
			// ----------------------------------------- SVI 2018 -----------------------------------------
			const sym1 = {
				type: "simple-fill",
				color: "#E6EECF",
				style: "solid",
				outline: {
					width: 0.2,
					color: "#6E6E6E"
				}
			};
			const sym2 = {
				type: "simple-fill",
				color: "#9BC4C1",
				style: "solid",
				outline: {
					width: 0.2,
					color: "#6E6E6E"
				}
			};
			const sym3 = {
				type: "simple-fill",
				color: "#69A8B7",
				style: "solid",
				outline: {
					width: 0.2,
					color: "#6E6E6E"
				}
			};
			const sym4 = {
				type: "simple-fill",
				color: "#4B7E98",
				style: "solid",
				outline: {
					width: 0.2,
					color: "#6E6E6E"
				}
			};
			const sym5 = {
				type: "simple-fill",
				color: "#2E557A",
				style: "solid",
				outline: {
					width: 0.2,
					color: "#6E6E6E"
				}
			};
			const break_renderer_info = [{
				// minValue: 0,
				maxValue: -999,
				symbol: sym1,
				label: "-999.0000"
			}, {
				minValue: -998.9999,
				maxValue: 0.25,
				symbol: sym2,
				label: "-998.9999 - 0.2500"
			}, {
				minValue: 0.2501,
				maxValue: 0.5001,
				symbol: sym3,
				label: "0.2501 - 0.5001"
			}, {
				minValue: 0.5002,
				maxValue: 0.7501,
				symbol: sym4,
				label: "0.5002 - 0.7501"
			}, {
				minValue: 0.5002,
				maxValue: 1,
				symbol: sym5,
				label: "0.7502 - 1.0000"
			}]


			let RPL_THEME1_renderer = new ClassBreaksRenderer({
				field: "RPL_THEME1",
				classBreakInfos: break_renderer_info
			});
			let RPL_THEME2_renderer = new ClassBreaksRenderer({
				field: "RPL_THEME2",
				classBreakInfos: break_renderer_info
			});
			let RPL_THEME3_renderer = new ClassBreaksRenderer({
				field: "RPL_THEME3",
				classBreakInfos: break_renderer_info
			});
			let RPL_THEME4_renderer = new ClassBreaksRenderer({
				field: "RPL_THEME4",
				classBreakInfos: break_renderer_info
			});


			let SVI_2018_RPL_THEME1 = new FeatureLayer({
				url: "https://services.arcgis.com/b3fMqPOmotX6SV4k/arcgis/rest/services/SVI2018_TEXAS_tract/FeatureServer",
				renderer: RPL_THEME1_renderer,
				title: "Socioeconomic"
			});
			let SVI_2018_RPL_THEME2 = new FeatureLayer({
				url: "https://services.arcgis.com/b3fMqPOmotX6SV4k/arcgis/rest/services/SVI2018_TEXAS_tract/FeatureServer",
				renderer: RPL_THEME2_renderer,
				title: "Household Composition & Disability"
			});
			let SVI_2018_RPL_THEME3 = new FeatureLayer({
				url: "https://services.arcgis.com/b3fMqPOmotX6SV4k/arcgis/rest/services/SVI2018_TEXAS_tract/FeatureServer",
				renderer: RPL_THEME3_renderer,
				title: "Minority Status & Language"
			});
			let SVI_2018_RPL_THEME4 = new FeatureLayer({
				url: "https://services.arcgis.com/b3fMqPOmotX6SV4k/arcgis/rest/services/SVI2018_TEXAS_tract/FeatureServer",
				renderer: RPL_THEME4_renderer,
				title: "Housing Type & Transportation"
			});

			const SVI_2018 = new GroupLayer({
				title: "CDC SVI 2018",
				visible: false,
				visibilityMode: "exclusive",
				layers: [
					SVI_2018_RPL_THEME4, SVI_2018_RPL_THEME3, SVI_2018_RPL_THEME2, SVI_2018_RPL_THEME1
				]
			});

			reactiveUtils.watch(
				() => SVI_2018.visible,
				(visible) => {
					if (visible) {
						view.goTo({
							center: [-99, 31],
							zoom: home_zoom - 1
						});
					} else {
						view_go_home()
					}
				});
			// ----------------------------------------- Harris damage -----------------------------------------
			const layer_HCADParcels2017 = new TileLayer({
				url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/HCAD_Parcels_2017/MapServer",
				listMode: "hide-children",
				title: "Parcels"
				// legendEnabled : false
			});
			const layer_HCADCommercialDamaged = new FeatureLayer({
				url: "https://services.arcgis.com/b3fMqPOmotX6SV4k/arcgis/rest/services/Harris/FeatureServer/48",
				title: "Commercial damaged"
			});
			const layer_HCADResidentialDamaged = new FeatureLayer({
				url: "https://services.arcgis.com/b3fMqPOmotX6SV4k/arcgis/rest/services/Harris/FeatureServer/49",
				title: "Residential damaged"
			});
			const harrisGroupLayer = new GroupLayer({
				title: "Damage in Harris county",
				visible: false,
				layers: [layer_HCADResidentialDamaged, layer_HCADCommercialDamaged, layer_HCADParcels2017],
				// opacity: 0.75
			});

			reactiveUtils.watch(
				() => harrisGroupLayer.visible,
				(visible) => {
					if (visible) {
						view.goTo({
							center: home_center,
							zoom: home_zoom + 3
						});
					} else {
						view_go_home()
					}
				});
			// ----------------------------------------- NOAA Harvey Imagery -----------------------------------------
			const aug27a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170827-rgb"
				},
				title: "August 27 2017"
			});
			const aug28a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170828a-rgb"
				},
				title: "August 28 2017 Flight 1"
			});
			const aug28b_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170828b-rgb"
				},
				title: "August 28 2017 Flight 2"
			});
			const aug29a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170829a-rgb"
				},
				title: "August 29 2017 Oblique"
			});
			const aug29b_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170829b-rgb"
				},
				title: "August 29 2017 Nadir"
			});
			const aug30a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170830-rgb"
				},
				title: "August 30 2017"
			});
			const aug31a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170831a-rgb"
				},
				title: "August 31 2017 Flight 1"
			});
			const aug31b_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170831b-rgb"
				},
				title: "August 31 2017 Flight 2"
			});

			const sept01a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170901a-rgb"
				},
				title: "September 01 2017 Flight 1"
			});
			const sept01b_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170901b-rgb"
				},
				title: "September 01 2017 Flight 2"
			});
			const sept01c_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170901c-rgb"
				},
				title: "September 01 2017 Flight 3"
			});

			const sept02a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170902a-rgb"
				},
				title: "September 02 2017 Flight 1"
			});
			const sept02b_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170902b-rgb"
				},
				title: "September 02 2017 Flight 2"
			});
			const sept02c_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170902c-rgb"
				},
				title: "September 02 2017 Flight 3"
			});
			const sept03a_ob = new WMTSLayer({
				url: "https://storms.ngs.noaa.gov/storms/tilesd/services/tileserver.php/wmts",
				activeLayer: {
					id: "20170903a-rgb"
				},
				title: "September 03 2017"
			});
			const NOAA_harvey_imagery = new GroupLayer({
				title: "NOAA Imagery",
				visible: false,
				layers: [
					sept03a_ob, sept02c_ob, sept02b_ob, sept02a_ob, sept01c_ob, sept01b_ob, sept01a_ob,
					aug31b_ob, aug31a_ob, aug30a_ob, aug29b_ob, aug29a_ob, aug28b_ob, aug28a_ob,
					aug27a_ob
				]
			});

			reactiveUtils.watch(
				() => NOAA_harvey_imagery.visible,
				(visible) => {
					if (visible) {
						view.goTo({
							center: home_center,
							zoom: home_zoom + 1
						});
					} else {
						view.goTo({
							center: home_center,
							zoom: home_zoom
						});
					}
				});
			// ----------------------------------------- MAXAR Hurricane Harvey Imagery -----------------------------------------
			const pre_event = new TileLayer({
				url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/Harris_pre_event/MapServer",
				title: "Pre-event",
				listMode: "hide-children"
			})

			const post_event = new TileLayer({
				url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/Harris_post_event/MapServer",
				title: "Post-event",
				listMode: "hide-children"
			})
			const MAXAR = new GroupLayer({
				title: "MAXAR Imagery",
				visible: false,
				layers: [post_event, pre_event]
			});

			// create a new Swipe widget for MAXAR Imagery
			const swipe = new Swipe({
				leadingLayers: [pre_event],
				trailingLayers: [post_event],
				position: 50,
				view: view
			});

			reactiveUtils.watch(
				() => MAXAR.visible,
				(visible) => {
					if (visible) {
						// add the widget to the view
						view.ui.add(swipe);
						view.goTo({
							center: home_center,
							zoom: home_zoom + 3
						});
					} else {
						view.ui.remove(swipe);
						view_go_home()
					}
				});

		// ----------------------------------------- add previous layers to map -----------------------------------------
			map.add(NOAA_harvey_imagery)
			map.add(MAXAR)
			map.add(SVI_2018)
			map.add(harrisGroupLayer)
			map.layers.push(
				view_patientscount1q2016, view_patientscount2q2016, view_patientscount3q2016, view_patientscount4q2016,
				view_patientscount1q2017, view_patientscount2q2017, view_patientscount3q2017, view_patientscount4q2017,
				view_patientscount1q2018, view_patientscount2q2018, view_patientscount3q2018, view_patientscount4q2018,
				view_patientscount1q2019, view_patientscount2q2019);
			map.add(hurricane_harvey_trajectory)
			map.add(layer_hospital)
			// map.add(twitter_texas_2017_08_26)
			//map.add(twitter_windswath_2017_08_26)

			// ----------------------------------------- Add Basemap Gallery -----------------------------------------
			const basemapGallery = new BasemapGallery({
				view: view,
				container: document.createElement("div")
			});

			// Create an Expand instance and set the content
			// property to the DOM node of the basemap gallery widget
			const bgExpand = new Expand({
				view: view,
				content: basemapGallery
			});

			// Add the expand instance to the ui
			view.ui.add(bgExpand, "top-left");

			// ----------------------------------------- Add LayerList & Legend widget -----------------------------------------
			view.ui.add(new LayerList({
				view: view
			}), "bottom-right");

			view.ui.add(new Legend({
				view: view
			}), "bottom-left");

			
			// ----------------------------------------- Add filters and charts for Patients count -----------------------
			let numClassesInput, slider;
			var patientstypeFilter, sexFilter, raceFilter, ageFilter;
			var fieldName1, fieldName2;
			var subtitle = "";

			var patientstype = ["All", "IP", "OP"];
			var sex = ["0", "1", "2"];
			var race = ["0", "1", "2", "3", "41", "42", "5"];
			var age = ["0", "1", "2", "3"];
			var patientstypeFilter = document.createElement("select");
			var sexFilter = document.createElement("select");
			var raceFilter = document.createElement("select");
			var ageFilter = document.createElement("select");
			filterClass = "esri-widget esri-select";
			filterStyle = "width: 275px; font-family: Avenir Next W00; font-size: 1em;";
			patientstypeFilter.setAttribute("id", "patientstypeSelect");
			patientstypeFilter.setAttribute("class", filterClass);
			patientstypeFilter.setAttribute("style", filterStyle);
			sexFilter.setAttribute("id", "sexSelect");
			sexFilter.setAttribute("class", filterClass);
			sexFilter.setAttribute("style", filterStyle);
			raceFilter.setAttribute("id", "raceSelect");
			raceFilter.setAttribute("class", filterClass);
			raceFilter.setAttribute("style", filterStyle);
			ageFilter.setAttribute("id", "ageSelect");
			ageFilter.setAttribute("class", filterClass);
			ageFilter.setAttribute("style", filterStyle);
			patientstype.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				option.innerHTML = "PatientsType: " + sql;
				patientstypeFilter.appendChild(option);
			});
			sex.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				// # "0" All  "1" Female "2" Male
				switch (sql) {
					case "0":
						option.innerHTML = "Sex: All";
						break;
					case "1":
						option.innerHTML = "Sex: Female";
						break;
					case "2":
						option.innerHTML = "Sex: Male";
						break;
				};
				sexFilter.appendChild(option);
			});
			race.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				// # 1 American Indian / Eskimo / Aleut 2 Asian or Pacific Islander 3 Black
				// # 41 White(Hispanic Origin) 42 White(Not of Hispanic Origin) 5 Other
				var race = ["0", "1", "2", "3", "41", "42", "5"];
				switch (sql) {
					case "0":
						option.innerHTML = "Race: All";
						break;
					case "1":
						option.innerHTML = "Race: American Indian / Eskimo / Aleut";
						break;
					case "2":
						option.innerHTML = "Race: Asian or Pacific Islander";
						break;
					case "3":
						option.innerHTML = "Race: Black";
						break;
					case "41":
						option.innerHTML = "Race: White(Hispanic Origin)";
						break;
					case "42":
						option.innerHTML = "Race: White(Not of Hispanic Origin)";
						break;
					case "5":
						option.innerHTML = "Race: Other";
						break;
				};
				raceFilter.appendChild(option);
			});
			age.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				// # "0" All Ages; "1" Age 0 - 17; "2" Age 17 - 64; "3" Age 65 +
				switch (sql) {
					case "0":
						option.innerHTML = "Age: All";
						break;
					case "1":
						option.innerHTML = "Age: 0 - 17";
						break;
					case "2":
						option.innerHTML = "Age: 17 - 64";
						break;
					case "3":
						option.innerHTML = "Age: 65 +";
						break;
				};
				ageFilter.appendChild(option);
			});

			// default layer for patientscount
			var show_layer = view_patientscount1q2016;
			controlUI_addListener(show_layer)

			function controlUI_addListener(show_layer) {
				reactiveUtils.watch(
					() => show_layer.visible,
					(visible) => {
						if (visible) {
							view.ui.add(infoDiv, "top-right");
							document.getElementById("infoDiv").style.display = "block"

							view.ui.add(patientstypeFilter, "top-right");
							view.ui.add(sexFilter, "top-right");
							view.ui.add(raceFilter, "top-right");
							view.ui.add(ageFilter, "top-right");

							reset_plots_width()
							// console.log(`patients count layer is turned on`);

							view.goTo({
								center: [-100, 30],
								zoom: home_zoom - 1
							});

							// layer and renderer
							timeSelect = document.getElementById("time-select");
							timeSelect.addEventListener("change", generateRenderer);

							classSelect = document.getElementById("class-select");
							classSelect.addEventListener("change", generateRenderer);

							numClassesInput = document.getElementById("num-classes");
							numClassesInput.addEventListener("change", generateRenderer);

							reactiveUtils.whenOnce(() => view.updating === false, generateRenderer)

							// filter
							patientstypeSelect.addEventListener("change", generateRenderer);
							sexSelect.addEventListener("change", generateRenderer);
							raceSelect.addEventListener("change", generateRenderer);
							ageSelect.addEventListener("change", generateRenderer);

							// init render effect
							generateRenderer()

							// Patients Count Comparison(ZipCode)
							// Get the screen point from the view's click event and load Chart(PatientsCount_zipcode)
							const x_data = ["1q2016", "2q2016", "3q2016", "4q2016", "1q2017", "2q2017", "3q2017",
								"4q2017", "1q2018", "2q2018", "3q2018", "4q2018", "1q2019", "2q2019"
							];

							loadChart_PatientsCount_zipcode(0, x_data, [{}, null, {}]);

							view.on("click", function (event) {
								var zip_code = "";
								var y_data = [];
								// Search for graphics at the clicked location. View events can be used
								// as screen locations as they expose an x,y coordinate that conforms
								// to the ScreenPoint definition.
								view.hitTest(event).then(function (response) {
									if (response.results.length) {
										if (fieldName1 == "All") {
											for (i in x_data) {
												var graphic = response.results.filter(function (result) {
													// check if the graphic belongs to the layer of interest
													return result.graphic.layer === eval('view_patientscount' + x_data[i])
												})[0].graphic;
												y_data[i] = Number(eval('graphic.attributes.IP' + fieldName2)) +
													Number(eval('graphic.attributes.OP' + fieldName2));
											}
											zip_code = graphic.attributes.ZIP_CODE;
										} else {
											for (i in x_data) {
												var graphic = response.results.filter(function (result) {
													// check if the graphic belongs to the layer of interest
													return result.graphic.layer === eval('view_patientscount' + x_data[i])
												})[0].graphic;
												y_data[i] = Number(eval('graphic.attributes.' + fieldName1 + fieldName2));
											}
											zip_code = graphic.attributes.ZIP_CODE;
										}

										loadChart_PatientsCount_zipcode(zip_code, x_data, y_data);

										// clear color of the last clicked feature 
										view.graphics.removeAll();
										// highlight the clicked feature in red color
										graphic.symbol = {
											type: "simple-fill",
											color: "red",
											outline: {
												color: [128, 128, 128, 0.5],
												width: "0.5px"
											}
										};
										view.graphics.add(graphic); //add color
									};
								});
							});
						} else {
							// this will be useless when I changed the show_layer
							document.getElementById("infoDiv").style.display = "none"
							view.ui.remove(infoDiv, "top-right");

							view.ui.remove(patientstypeFilter, "top-right");
							view.ui.remove(sexFilter, "top-right");
							view.ui.remove(raceFilter, "top-right");
							view.ui.remove(ageFilter, "top-right");
							// clear color of the last clicked feature
							view.graphics.removeAll();
							// clear the Patients Count Comparison chart
							// document.getElementById('container_PatientsCount_zipcode').innerHTML = "";
							zeroing_plots_width()
							// console.log(`patients count layer is turned off`);
							view.goTo({
								center: home_center,
								zoom: home_zoom
							});
						}
					}
				);
			}

			function zeroing_plots_width() {
				document.getElementById("viewDiv").style.width = "100%"
				document.getElementById('container_plots').style.width = 0
			}
			function reset_plots_width() {
				document.getElementById("viewDiv").style.width = "70%"
				document.getElementById("container_plots").style.width = "30%"
			}

			// load HighCharts when click patients count layer
			function loadChart_PatientsCount_zipcode(zip_code, x_data, y_data) {
				var chart = Highcharts.chart('container_PatientsCount_zipcode', {
					chart: {
						type: 'line',
					},
					title: {
						text: zip_code ? 'Patients Count under given Filter' : "Please click on the location you are interested in in the layer."
					},
					subtitle: {
						text: zip_code ? 'Zip Code: ' + zip_code : 'Zip Code: '
					},
					xAxis: {
						categories: x_data,
						plotLines: [{
							color: 'red',
							width: 2,
							value: 6,
							// zIndex: 5
							label: {
								text: "Hurricane Harvey",
								verticalAlign: 'top',
								textAlign: 'left',
								rotation: 0
							}
						}]
					},
					yAxis: {
						title: {
							text: 'Patients Count'
						}
					},
					plotOptions: {
						line: {
							dataLabels: {
								enabled: true
							},
							enableMouseTracking: true
						}
					},
					series: [{
						name: 'Patients Count',
						data: y_data
					}],
					responsive: {
						rules: [{
							condition: {
								maxWidth: 400
							},
							// Make the labels less space demanding on mobile
							chartOptions: {
								chart: {
									height: "100%"
								},
							}
						}]
					}
				});
			}

			// thcic_id, providerName, y_data
			// Generate rounded arcade expression when user selects a field name
			function getValueExpression(fieldName1, fieldName2) {
				if (fieldName1 == "All") {
					return ("Round( ($feature.IP" + fieldName2 + ") )+Round( ($feature.OP" + fieldName2 + ") )");
				} else {
					return ("Round( ($feature." + fieldName1 + fieldName2 + ") )");
				}
			}

			function generateRenderer() {
				fieldName1 = patientstypeSelect.value;
				fieldName2 = sexSelect.value + raceSelect.value + ageSelect.value;
				var subtitle = "";

				var layerTime = timeSelect.options[timeSelect.selectedIndex].value;
				if (!(layerTime === show_layer.id)) {
					show_layer.opacity = 0;
					show_layer.legendEnabled = false;
					show_layer.listMode = "hide";

					show_layer = map.findLayerById(layerTime)
					show_layer.opacity = 1;
					show_layer.legendEnabled = true;
					show_layer.listMode = "show"
					controlUI_addListener(show_layer)
				}

				fieldName1 = patientstypeSelect.value;
				fieldName2 = sexSelect.value + raceSelect.value + ageSelect.value;
				subtitle = patientstypeSelect.options[patientstypeSelect.selectedIndex].text + " " + sexSelect.options[sexSelect
					.selectedIndex]
					.text + " " + raceSelect.options[raceSelect.selectedIndex].text + " " + ageSelect.options[ageSelect.selectedIndex]
						.text;
				console.log(fieldName1 + fieldName2);

				// default to natural-breaks when manual is selected for classification method
				const classificationMethod = document.getElementById("class-select").value === "manual" ? "natural-breaks" : document.getElementById("class-select").value;

				var params = {
					layer: show_layer,
					valueExpression: getValueExpression(fieldName1, fieldName2),
					view: view,
					classificationMethod: classificationMethod,
					numClasses: parseInt(document.getElementById("num-classes").value),
					// legendOptions: {
					// 	title: title
					// }
				};

				// clear the selected feature
				view.graphics.removeAll();
				// clear the Patients Count Comparison chart
				document.getElementById('container_PatientsCount_zipcode').innerHTML = "";

				// generate the renderer and set it on the layer
				colorRendererCreator
					.createClassBreaksRenderer(params)
					.then(function (rendererResponse) {
						show_layer.renderer = rendererResponse.renderer;

						if (classSelect.value === "manual") {
							// if manual is selected, then add or update
							// a classed color slider to allow the user to
							// construct manual class breaks
							updateColorSlider(rendererResponse, show_layer);
						} else {
							destroySlider(slider);
						}
					})
			}

			// If manual classification method is selected, then create
			// a classed color slider to allow user to manually modify
			// the class breaks starting with the generated renderer
			function updateColorSlider(rendererResult, show_layer) {
				histogram({
					layer: show_layer,
					valueExpression: getValueExpression(fieldName1, fieldName2),
					view: view,
					numBins: 100
				}).then(function (histogramResult) {
					if (!slider) {
						const sliderContainer = document.createElement("div");
						const container = document.createElement("div");
						container.id = "containerDiv";
						container.appendChild(sliderContainer);
						view.ui.add(container, "top-right");

						slider = ClassedColorSlider.fromRendererResult(
							rendererResult,
							histogramResult
						);
						slider.container = container;
						slider.viewModel.precision = 1;

						function changeEventHandler() {
							const renderer = show_layer.renderer.clone();
							renderer.classBreakInfos = slider.updateClassBreakInfos(
								renderer.classBreakInfos
							);
							show_layer.renderer = renderer;
						}

						slider.on(
							["thumb-change", "thumb-drag", "min-change", "max-change"],
							changeEventHandler
						);
					} else {
						slider.updateFromRendererResult(rendererResult, histogramResult);
					}
				});
			}

			function destroySlider(slider) {
				if (slider) {
					let container = document.getElementById("containerDiv");
					view.ui.remove(container);
					slider.container = null;
					slider = null;
					container = null;
				}
			}
		});
	</script>
</body>

</html>